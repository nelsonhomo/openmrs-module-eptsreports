package org.openmrs.module.eptsreports.reporting.library.queries.mi;

public interface MICategory15QueriesInterface {

  class QUERY {

    public static final String findPatientsWithClinicalConsultationDuringRevisionPeriod =
        "Select maxEnc.patient_id from ( "
            + "Select p.patient_id,max(e.encounter_datetime) encounter_datetime from patient p "
            + "inner join encounter e on p.patient_id=e.patient_id "
            + "where p.voided=0 and e.voided=0 and e.encounter_type=6 and "
            + "e.encounter_datetime >=:startInclusionDate and e.encounter_datetime<=:endInclusionDate  and e.location_id=:location "
            + "group by p.patient_id "
            + ")maxEnc";

    public static final String
        findPatientsWithClinicalConsultationDuringRevisionPeriodAndAgeGreaterOrEqualTwoYears =
            "Select maxEnc.patient_id from ( "
                + "Select p.patient_id,max(e.encounter_datetime) encounter_datetime from patient p "
                + "inner join encounter e on p.patient_id=e.patient_id "
                + "where p.voided=0 and e.voided=0 and e.encounter_type=6 and "
                + "e.encounter_datetime >=:startInclusionDate and e.encounter_datetime<=:endInclusionDate  and e.location_id=:location "
                + "group by p.patient_id "
                + ")maxEnc "
                + "INNER JOIN person pe ON maxEnc.patient_id=pe.person_id "
                + "and (TIMESTAMPDIFF(year,pe.birthdate,maxEnc.encounter_datetime)) >=2 AND pe.birthdate IS NOT NULL ";

    public static final String findPatientsWhoArePregnantSpecificForCategory15MI =
        " SELECT p.patient_id FROM person pe "
            + " INNER JOIN patient p ON pe.person_id = p.patient_id "
            + " INNER JOIN encounter e ON p.patient_id = e.patient_id "
            + " INNER JOIN obs obsGravida ON e.encounter_id = obsGravida.encounter_id "
            + " WHERE pe.voided = 0 AND p.voided = 0 AND e.voided = 0 AND obsGravida.voided = 0 AND e.encounter_type = 6 AND e.location_id = :location "
            + " AND e.encounter_datetime between (:endRevisionDate - INTERVAL 11 MONTH + INTERVAL 1 DAY) and (:endRevisionDate - INTERVAL 2 MONTH) "
            + " AND obsGravida.concept_id = 1982 AND obsGravida.value_coded = 1065 AND pe.gender = 'F' "
            + " group by patient_id ";

    public static final String findPatientsWhoAreBreastfeedingSpecificForCategory15MI =
        " SELECT p.patient_id FROM person pe "
            + " INNER JOIN patient p ON pe.person_id = p.patient_id "
            + " INNER JOIN encounter e ON p.patient_id = e.patient_id "
            + " INNER JOIN obs obsLactante ON e.encounter_id = obsLactante.encounter_id "
            + " WHERE pe.voided = 0 AND p.voided = 0 AND e.voided = 0 AND obsLactante.voided = 0 AND e.encounter_type = 6 AND e.location_id = :location "
            + " AND e.encounter_datetime between (:endRevisionDate - INTERVAL 20 MONTH + INTERVAL 1 DAY) and (:endRevisionDate - INTERVAL 2 MONTH) "
            + " AND obsLactante.concept_id = 6332 AND obsLactante.value_coded = 1065 AND pe.gender = 'F' "
            + " group by patient_id ";

    public static final String
        findPatientsWithClinicalConsultationAndARTStartDateGreaterThanThreeMonths =
            " SELECT patient_id from ( "
                + " select art.patient_id, art.art_start_date from (SELECT patient_id, art_start_date FROM ( "
                + " SELECT patient_id, MIN(art_start_date) art_start_date FROM ( "
                + " SELECT p.patient_id, MIN(value_datetime) art_start_date FROM patient p "
                + " INNER JOIN encounter e ON p.patient_id = e.patient_id "
                + " INNER JOIN obs o ON e.encounter_id = o.encounter_id "
                + " WHERE p.voided = 0 AND e.voided = 0 AND o.voided = 0 AND e.encounter_type = 53 "
                + " AND o.concept_id = 1190 AND o.value_datetime is NOT NULL AND o.value_datetime <= :endRevisionDate AND e.location_id = :location "
                + " GROUP BY p.patient_id "
                + " ) art_start "
                + " GROUP BY art_start.patient_id "
                + " ) tx_new "
                + ") art "
                + "inner join "
                + "(select patient_id, encounter_datetime from ( "
                + "select p.patient_id, max(e.encounter_datetime) encounter_datetime FROM patient p "
                + "INNER JOIN encounter e on p.patient_id=e.patient_id "
                + "where p.voided=0 and e.voided=0 and  e.encounter_type = 6 "
                + "and e.encounter_datetime >=:startInclusionDate and e.encounter_datetime<=:endInclusionDate "
                + "and e.location_id=:location "
                + "group by p.patient_id "
                + ") maxEnc "
                + ") consulta on consulta.patient_id = art.patient_id "
                + "INNER JOIN person pe ON art.patient_id=pe.person_id "
                + "and (TIMESTAMPDIFF(year,pe.birthdate,consulta.encounter_datetime)) >=2 AND pe.birthdate IS NOT NULL and pe.voided = 0 "
                + "where (TIMESTAMPDIFF(MONTH,art.art_start_date,consulta.encounter_datetime)) >3 "
                + ") final ";

    public static final String
        findPatientsWithClinicalConsultationAndARTStartDateGreaterThanTwentyOneMonths =
            " SELECT patient_id from ( "
                + " select art.patient_id, art.art_start_date from (SELECT patient_id, art_start_date FROM ( "
                + " SELECT patient_id, MIN(art_start_date) art_start_date FROM ( "
                + " SELECT p.patient_id, MIN(value_datetime) art_start_date FROM patient p "
                + " INNER JOIN encounter e ON p.patient_id = e.patient_id "
                + " INNER JOIN obs o ON e.encounter_id = o.encounter_id "
                + " WHERE p.voided = 0 AND e.voided = 0 AND o.voided = 0 AND e.encounter_type = 53 "
                + " AND o.concept_id = 1190 AND o.value_datetime is NOT NULL AND o.value_datetime <= :endRevisionDate AND e.location_id = :location "
                + " GROUP BY p.patient_id "
                + " ) art_start "
                + " GROUP BY art_start.patient_id "
                + " ) tx_new "
                + ") art "
                + "inner join "
                + "(select patient_id, encounter_datetime from ( "
                + "select p.patient_id, max(e.encounter_datetime) encounter_datetime FROM patient p "
                + "INNER JOIN encounter e on p.patient_id=e.patient_id "
                + "where p.voided=0 and e.voided=0 and  e.encounter_type = 6 "
                + "and e.encounter_datetime >=:startInclusionDate and e.encounter_datetime<=:endInclusionDate "
                + "and e.location_id=:location "
                + "group by p.patient_id "
                + ") maxEnc ) consulta on consulta.patient_id = art.patient_id "
                + "where (TIMESTAMPDIFF(MONTH,art.art_start_date,consulta.encounter_datetime)) >24 "
                + ") final ";

    public static final String
        findPatientsWithClinicalConsultationAndARTStartDateGreaterThanTwentyFourMonths =
            " SELECT patient_id from ( "
                + " select art.patient_id, art.art_start_date from (SELECT patient_id, art_start_date FROM ( "
                + " SELECT patient_id, MIN(art_start_date) art_start_date FROM ( "
                + " SELECT p.patient_id, MIN(value_datetime) art_start_date FROM patient p "
                + " INNER JOIN encounter e ON p.patient_id = e.patient_id "
                + " INNER JOIN obs o ON e.encounter_id = o.encounter_id "
                + " WHERE p.voided = 0 AND e.voided = 0 AND o.voided = 0 AND e.encounter_type = 53 "
                + " AND o.concept_id = 1190 AND o.value_datetime is NOT NULL AND o.value_datetime <= :endRevisionDate AND e.location_id = :location "
                + " GROUP BY p.patient_id "
                + " ) art_start "
                + " GROUP BY art_start.patient_id "
                + " ) tx_new "
                + ") art "
                + "inner join "
                + "(select patient_id, encounter_datetime from ( "
                + "select p.patient_id, max(e.encounter_datetime) encounter_datetime FROM patient p "
                + "INNER JOIN encounter e on p.patient_id=e.patient_id "
                + "where p.voided=0 and e.voided=0 and  e.encounter_type = 6 "
                + "and e.encounter_datetime >=:startInclusionDate and e.encounter_datetime<=:endInclusionDate "
                + "and e.location_id=:location "
                + "group by p.patient_id "
                + ") maxEnc ) consulta on consulta.patient_id = art.patient_id "
                + "where (TIMESTAMPDIFF(MONTH,art.art_start_date,consulta.encounter_datetime)) >24 "
                + ") final ";

    public static final String findPatientsWithClinicalConsultationOrARTPickUpInTheLastThreeMonths =
        "select enc.patient_id  from "
            + "( "
            + "select p.patient_id,  max(e.encounter_datetime) data FROM patient p "
            + "INNER JOIN encounter e on p.patient_id=e.patient_id "
            + "where p.voided=0 and e.voided=0 and  e.encounter_type = 6 "
            + "and e.encounter_datetime  between :startInclusionDate and  :endInclusionDate and e.location_id=:location "
            + "group by patient_id "
            + ") a "
            + "inner join "
            + "( "
            + "select p.patient_id,e.encounter_datetime data FROM patient p "
            + "INNER JOIN encounter e on p.patient_id=e.patient_id "
            + "where p.voided=0 and e.voided=0 and  e.encounter_type = 6 "
            + "and e.encounter_datetime  <= :endRevisionDate "
            + "and e.location_id=:location "
            + "union "
            + "SELECT p.patient_id, value_datetime data FROM patient p "
            + "INNER JOIN encounter e on p.patient_id=e.patient_id "
            + "inner join obs o on e.encounter_id=o.encounter_id "
            + "where p.voided=0 and e.voided=0 and o.voided=0 and e.encounter_type=52 AND o.concept_id=23866 and e.location_id=:location "
            + "and o.value_datetime <= :endRevisionDate "
            + ")enc  on a.patient_id = enc.patient_id "
            + "and enc.data  between date_sub(a.data, INTERVAL 30 DAY) and date_sub(a.data, INTERVAL 1 DAY) "
            + "inner join "
            + "( "
            + "select p.patient_id,e.encounter_datetime data FROM patient p "
            + "INNER JOIN encounter e on p.patient_id=e.patient_id "
            + "where p.voided=0 and e.voided=0 and  e.encounter_type = 6 "
            + "and e.encounter_datetime  <= :endRevisionDate "
            + "and e.location_id=:location "
            + "union "
            + "SELECT p.patient_id, value_datetime data FROM patient p "
            + "INNER JOIN encounter e on p.patient_id=e.patient_id "
            + "inner join obs o on e.encounter_id=o.encounter_id "
            + "where p.voided=0 and e.voided=0 and o.voided=0 and e.encounter_type=52 AND o.concept_id=23866 and e.location_id=:location "
            + "and o.value_datetime <= :endRevisionDate "
            + ")enc2  on a.patient_id = enc2.patient_id "
            + "and enc2.data  between date_sub(a.data, INTERVAL 60 DAY) and date_sub(a.data, INTERVAL 31 DAY) "
            + "inner join "
            + "( "
            + "select p.patient_id,e.encounter_datetime data FROM patient p "
            + "INNER JOIN encounter e on p.patient_id=e.patient_id "
            + "where p.voided=0 and e.voided=0 and  e.encounter_type = 6 "
            + "and e.encounter_datetime  <= :endRevisionDate "
            + "and e.location_id=:location "
            + "union "
            + "SELECT p.patient_id, value_datetime data FROM patient p "
            + "INNER JOIN encounter e on p.patient_id=e.patient_id "
            + "inner join obs o on e.encounter_id=o.encounter_id "
            + "where p.voided=0 and e.voided=0 and o.voided=0 and e.encounter_type=52 AND o.concept_id=23866 and e.location_id=:location "
            + "and o.value_datetime <= :endRevisionDate "
            + ")enc3  on a.patient_id = enc3.patient_id "
            + "and enc3.data  between date_sub(a.data, INTERVAL 90 DAY) and date_sub(a.data, INTERVAL 61 DAY) ";

    public static final String findPatientsWithTheLastCD4LessThan20O =
        "select cd4.patient_id from ( "
            + "Select p.patient_id, o.obs_datetime as data_cd4, o.concept_id  From patient p "
            + "inner join encounter e on p.patient_id=e.patient_id "
            + "inner join obs o on e.encounter_id=o.encounter_id "
            + "where p.voided=0 and e.voided=0 and o.voided=0 and concept_id = 1695 and  e.encounter_type = 6 and o.value_numeric<=200 and e.location_id=:location and o.obs_datetime<=:endRevisionDate "
            + "group by p.patient_id "
            + "union "
            + "Select p.patient_id, o.obs_datetime as data_cd4, o.concept_id  From patient p "
            + "inner join encounter e on p.patient_id=e.patient_id "
            + "inner join obs o on e.encounter_id=o.encounter_id "
            + "where p.voided=0 and e.voided=0 and o.voided=0 and concept_id = 165515 and  e.encounter_type = 6 and o.value_coded = 165513 and e.location_id=:location and o.obs_datetime<=:endRevisionDate "
            + "group by p.patient_id "
            + ")cd4 "
            + "left join   ( "
            + "Select p.patient_id, e.encounter_datetime as data_cv, o.concept_id From patient p "
            + "inner join encounter e on p.patient_id=e.patient_id "
            + "inner join obs o on e.encounter_id=o.encounter_id "
            + "where p.voided=0 and e.voided=0 and o.voided=0 and concept_id in(856,1305) and  e.encounter_type = 6  and e.location_id=:location and e.encounter_datetime<=:endRevisionDate "
            + "group by p.patient_id "
            + ")cv on cv.patient_id=cd4.patient_id "
            + "where cv.patient_id is null ";

    public static final String findPatientsWithTheLastCVBiggerThan1000 =
        "select f.patient_id from ( "
            + "Select p.patient_id, max(e.encounter_datetime) as data_cv, o.value_numeric  From patient p  "
            + "inner join encounter e on p.patient_id=e.patient_id  "
            + "inner join obs o on e.encounter_id=o.encounter_id  "
            + "where p.voided=0 and e.voided=0 and o.voided=0 and concept_id in(856)  "
            + "and  e.encounter_type = 6  and e.location_id=:location and e.encounter_datetime<=:endRevisionDate and o.value_numeric >=1000 "
            + "group by p.patient_id   "
            + ")f ";

    public static final String
        findPatientsWithTheLastCargaViralGreaterOrEqualThan1000InClinicalConsultation =
            "select patient_id from "
                + "( "
                + "Select maxEnc.patient_id, Max(ultimaCVAlta.data_cv) data, maxEnc.encounter_datetime from "
                + "( "
                + "Select p.patient_id,max(e.encounter_datetime) encounter_datetime from patient p "
                + "inner join encounter e on p.patient_id=e.patient_id "
                + "where p.voided=0 and e.voided=0 and e.encounter_type=6 and "
                + "e.encounter_datetime between :startInclusionDate and :endInclusionDate and e.location_id=:location "
                + "group by p.patient_id "
                + ")maxEnc "
                + "inner join "
                + "( "
                + "Select p.patient_id, o.obs_datetime as data_cv "
                + "From patient p "
                + "inner join encounter e on p.patient_id=e.patient_id "
                + "inner join obs o on e.encounter_id=o.encounter_id "
                + "where p.voided=0 and e.voided=0 and o.voided=0 and concept_id = 856 and  e.encounter_type = 6 and o.value_numeric >= 1000 and e.location_id=:location "
                + ")ultimaCVAlta on ultimaCVAlta.patient_id = maxEnc.patient_id and ultimaCVAlta.data_cv < maxEnc.encounter_datetime "
                + "group by ultimaCVAlta.patient_id "
                + ")final ";

    public static final String
        findPatientsWithTheLastCargaViralGreaterOrEqualThan1000RegisteredInTheLastClinicalConsultation =
            "  select patient_id from (select maxEnc.patient_id, ultimaCVAlta.data_carga, encounter_datetime from ( "
                + "Select p.patient_id,max(e.encounter_datetime) encounter_datetime from patient p "
                + "inner join encounter e on p.patient_id=e.patient_id "
                + "where p.voided=0 and e.voided=0 and e.encounter_type=6 and "
                + "e.encounter_datetime between :startInclusionDate and :endInclusionDate  and e.location_id=:location "
                + "group by p.patient_id "
                + ")maxEnc "
                + "  inner join "
                + " ( Select p.patient_id, max(e.encounter_datetime) data_carga "
                + " from patient p "
                + " inner join encounter e on p.patient_id = e.patient_id "
                + " inner join obs o on e.encounter_id=o.encounter_id "
                + " where 	p.voided = 0 and e.voided = 0 and o.voided = 0 and e.encounter_type = 6 and  o.concept_id = 856 and e.location_id = :location and o.value_numeric >= 1000 "
                + " and e.encounter_datetime <= :endInclusionDate "
                + " group by p.patient_id "
                + " ) ultimaCVAlta on ultimaCVAlta.patient_id = maxEnc.patient_id and ultimaCVAlta.data_carga = maxEnc.encounter_datetime "
                + " )final ";

    public static final String
        findPatientsRegisteredInOneMDSForStablePatientsAndHadCVBeforeTwentyMonthsOfLastClinicalConsultationThan1000 =
            "select e.patient_id  from "
                + "( "
                + " select ultimaCVAlta.patient_id, MAX(ultimaCVAlta.data_carga) as data_carga  from "
                + " (Select p.patient_id, max(e.encounter_datetime) encounter_datetime "
                + " from patient p "
                + " inner join encounter e on p.patient_id = e.patient_id "
                + " where p.voided = 0 and e.voided = 0 and e.encounter_type = 6 and "
                + " e.encounter_datetime between :startInclusionDate and :endInclusionDate and e.location_id =:location "
                + " group by p.patient_id "
                + " )maxEnc "
                + "   inner join "
                + "  ( Select p.patient_id, e.encounter_datetime as data_carga "
                + "  from patient p "
                + "  inner join encounter e on p.patient_id = e.patient_id "
                + "  inner join obs o on e.encounter_id = o.encounter_id "
                + "  where p.voided = 0 and e.voided = 0 and o.voided = 0 and e.encounter_type = 6 and ((o.concept_id = 856 and o.value_numeric < 1000) OR (o.concept_id = 1305 and o.value_coded is not null)) and e.location_id =:location "
                + "  ) ultimaCVAlta on ultimaCVAlta.patient_id = maxEnc.patient_id and ultimaCVAlta.data_carga < (maxEnc.encounter_datetime - INTERVAL 20 MONTH) "
                + "	group by ultimaCVAlta.patient_id "
                + "  )final "
                + "  inner join encounter e on e.patient_id = final.patient_id "
                + "  inner join obs o on e.encounter_id = o.encounter_id "
                + "  where e.voided = 0 and o.voided = 0 and e.encounter_type = 6 and ((o.concept_id = 856 and o.value_numeric is not null) OR (o.concept_id = 1305 and o.value_coded is not null)) "
                + "  and e.location_id =:location and e.encounter_datetime between (final.data_carga + INTERVAL 10 MONTH) and (final.data_carga + INTERVAL 20 MONTH) "
                + "  group by e.patient_id ";

    public static final String
        findPatientsRegisteredInOneMDSForStablePatientsAndHadCVBetween18And24nMonthsAfterCVLessThan1000 =
            "			select distinct e.patient_id from "
                + "			( "
                + "			 select ultimaCVAlta.patient_id, MAX(ultimaCVAlta.data_carga) as data_carga from "
                + "			 (Select p.patient_id, max(e.encounter_datetime) encounter_datetime "
                + "			 from patient p "
                + "                inner join encounter e on p.patient_id = e.patient_id "
                + "                where p.voided = 0 and e.voided = 0 and e.encounter_type = 6 and "
                + "                e.encounter_datetime >= :startInclusionDate and e.encounter_datetime <= :endInclusionDate  and e.location_id = :location "
                + "                group by p.patient_id "
                + "                )maxEnc "
                + "                  inner join "
                + "                 ( Select p.patient_id, e.encounter_datetime as data_carga "
                + "                 from patient p "
                + "                 inner join encounter e on p.patient_id = e.patient_id "
                + "                 inner join obs o on e.encounter_id = o.encounter_id "
                + "                 where p.voided = 0 and e.voided = 0 and o.voided = 0 and e.encounter_type = 6 and ((o.concept_id = 856 and o.value_numeric < 1000) OR (o.concept_id = 1305 and o.value_coded is not null)) and e.location_id = :location "
                + "                 group by p.patient_id "
                + "                 ) ultimaCVAlta on ultimaCVAlta.patient_id = maxEnc.patient_id and ultimaCVAlta.data_carga < maxEnc.encounter_datetime and ultimaCVAlta.data_carga < (maxEnc.encounter_datetime - INTERVAL 18 MONTH) "
                + "				group by ultimaCVAlta.patient_id "
                + "                 )final "
                + "                 inner join encounter e on e.patient_id = final.patient_id "
                + "                 inner join obs o on e.encounter_id = o.encounter_id "
                + "                 where e.voided = 0 and o.voided = 0 and e.encounter_type = 6 and o.concept_id = 856 and o.value_numeric is not null "
                + "                 and e.location_id = :location and e.encounter_datetime between (final.data_carga + INTERVAL 18 MONTH) and (final.data_carga + INTERVAL 24 MONTH) ";

    public static final String
        findAllPatientsWhoHaveLaboratoryInvestigationsRequestsAndViralChargeInLastConsultationDuringLast12Months =
            "Select patient_id from ( "
                + "Select maxEnc.patient_id,maxEnc.encounter_datetime, obsCV.obs_datetime from ( "
                + "Select p.patient_id,max(e.encounter_datetime) encounter_datetime from patient p "
                + "inner join encounter e on p.patient_id=e.patient_id "
                + "where p.voided=0 and e.voided=0 and e.encounter_type=6 and "
                + "e.encounter_datetime >=:startInclusionDate and e.encounter_datetime<=:endInclusionDate and e.location_id=:location "
                + "group by p.patient_id "
                + ") maxEnc "
                + "inner join encounter  e on e.patient_id=maxEnc.patient_id "
                + "inner join obs obsCV on obsCV.encounter_id=e.encounter_id "
                + "where obsCV.concept_id=23722 and obsCV.value_coded = 856 and obsCV.voided=0 and e.voided=0 "
                + " and e.encounter_type  = 6 and e.location_id = :location "
                + "and e.encounter_datetime >= (maxEnc.encounter_datetime - INTERVAL 12 MONTH) AND  e.encounter_datetime < maxEnc.encounter_datetime "
                + "group by maxEnc.patient_id "
                + ") final "
                + "group by final.patient_id ";

    public static final String findPatientsWhoAreActiveOnArtAndInAtleastOneDSD =
        "select patient_id from ( "
            + "select penultima.patient_id from ( "
            + "select maxEnc.patient_id,max(penultima.data) dataPenultima, maxEnc.data  from  ( "
            + "select p.patient_id, max(e.encounter_datetime) data FROM patient p "
            + "INNER JOIN encounter e on p.patient_id=e.patient_id "
            + "where p.voided=0 and e.voided=0 and  e.encounter_type = 6 "
            + "and e.encounter_datetime  between  :startInclusionDate and :endInclusionDate and e.location_id=:location "
            + "group by patient_id "
            + ")maxEnc "
            + "inner join ( "
            + "select p.patient_id, e.encounter_datetime data FROM patient p "
            + "INNER JOIN encounter e on p.patient_id=e.patient_id "
            + "where p.voided=0 and e.voided=0 and  e.encounter_type = 6 and e.location_id=:location "
            + ")penultima on penultima.patient_id = maxEnc.patient_id "
            + "where penultima.data < maxEnc.data "
            + "group by maxEnc.patient_id "
            + ") penultima "
            + " inner join ( "
            + "select p.patient_id,e.encounter_datetime data_mdc from patient p "
            + "join encounter e on p.patient_id=e.patient_id "
            + "join obs grupo on grupo.encounter_id=e.encounter_id "
            + "join obs o on o.encounter_id=e.encounter_id "
            + "join obs obsEstado on obsEstado.encounter_id=e.encounter_id "
            + "where  e.encounter_type in(6) and e.location_id=:location and o.concept_id=165174 and o.value_coded in(23724,23730,165179,165315,23888,23729,165314) and o.voided=0 "
            + "and grupo.concept_id=165323  and grupo.voided=0 and obsEstado.concept_id=165322  and obsEstado.value_coded in(1256,1257)  and obsEstado.voided=0  and grupo.voided=0 "
            + "and grupo.obs_id=o.obs_group_id and grupo.obs_id=obsEstado.obs_group_id "
            + ")mdc on mdc.patient_id = penultima.patient_id "
            + "where mdc.data_mdc=penultima.dataPenultima "
            + "union "
            + "select patient_id from( "
            + "select maxEnc.patient_id,max(td.data_mdc) data_mdc from  ( "
            + "select p.patient_id, max(e.encounter_datetime) data FROM patient p "
            + "INNER JOIN encounter e on p.patient_id=e.patient_id "
            + "where p.voided=0 and e.voided=0 and  e.encounter_type = 6 "
            + "and e.encounter_datetime  between  :startInclusionDate and :endInclusionDate and e.location_id=:location "
            + "group by patient_id "
            + ")maxEnc "
            + "inner join( "
            + "select p.patient_id,o.obs_datetime data_mdc from patient p "
            + "join encounter e on p.patient_id=e.patient_id "
            + "join obs o on o.encounter_id=e.encounter_id "
            + "where e.encounter_type=6 and e.voided=0 and o.voided=0 and p.voided=0 and o.concept_id=23739 and e.location_id=:location "
            + ") td on td.patient_id = maxEnc.patient_id "
            + "where td.data_mdc<maxEnc.data "
            + "group by maxEnc.patient_id "
            + ") tipodispensa "
            + "inner join obs on obs.person_id=tipodispensa.patient_id and tipodispensa.data_mdc=obs.obs_datetime "
            + "where obs.concept_id=23739 and obs.value_coded in(23720,23888,165314) and obs.voided=0 and obs.location_id=:location "
            + "union "
            + "select patient_id from ( "
            + "select maxEnc.patient_id, max(fila.data_levantamento) data_levantamento from  ( "
            + "select p.patient_id, max(e.encounter_datetime) data FROM patient p "
            + "INNER JOIN encounter e on p.patient_id=e.patient_id "
            + "where p.voided=0 and e.voided=0 and  e.encounter_type = 6 "
            + "and e.encounter_datetime  between  :startInclusionDate and :endInclusionDate and e.location_id=:location "
            + "group by patient_id "
            + ")maxEnc "
            + "inner join( "
            + "Select p.patient_id,encounter_datetime data_levantamento  from  patient p "
            + "inner join encounter e on e.patient_id=p.patient_id "
            + "where  p.voided=0 and e.voided=0 and e.encounter_type=18 and e.location_id=:location "
            + ")fila on fila.patient_id =  maxEnc.patient_id "
            + "where fila.data_levantamento<maxEnc.data "
            + "group by maxEnc.patient_id "
            + ") fila "
            + "inner join  obs obs_fila on obs_fila.person_id=fila.patient_id "
            + "and obs_fila.voided=0  and obs_fila.obs_datetime=fila.data_levantamento "
            + "and obs_fila.concept_id=5096 "
            + "and obs_fila.location_id=:location "
            + "and (DATEDIFF(obs_fila.value_datetime,fila.data_levantamento) >= 83 and DATEDIFF(obs_fila.value_datetime,fila.data_levantamento) <= 97) "
            + "union "
            + "select patient_id from ( "
            + "select maxEnc.patient_id, max(fila.data_levantamento) data_levantamento from  ( "
            + "select p.patient_id, max(e.encounter_datetime) data FROM patient p "
            + "INNER JOIN encounter e on p.patient_id=e.patient_id "
            + "where p.voided=0 and e.voided=0 and  e.encounter_type = 6 "
            + "and e.encounter_datetime  between  :startInclusionDate and :endInclusionDate and e.location_id=:location "
            + "group by patient_id "
            + ")maxEnc "
            + "inner join( "
            + "Select p.patient_id,encounter_datetime data_levantamento  from  patient p "
            + "inner join encounter e on e.patient_id=p.patient_id "
            + "where  p.voided=0 and e.voided=0 and e.encounter_type=18 and e.location_id=:location "
            + ")fila on fila.patient_id =  maxEnc.patient_id "
            + "where fila.data_levantamento<maxEnc.data "
            + "group by maxEnc.patient_id "
            + ") fila "
            + "inner join  obs obs_fila on obs_fila.person_id=fila.patient_id "
            + "and obs_fila.voided=0  and obs_fila.obs_datetime=fila.data_levantamento "
            + "and obs_fila.concept_id=5096 "
            + "and obs_fila.location_id=:location "
            + "and (DATEDIFF(obs_fila.value_datetime,fila.data_levantamento) >= 173 and DATEDIFF(obs_fila.value_datetime,fila.data_levantamento) <= 187) "
            + "union "
            + "select patient_id from ( "
            + "select maxEnc.patient_id, max(fila.data_levantamento) data_levantamento from  ( "
            + "select p.patient_id, max(e.encounter_datetime) data FROM patient p "
            + "INNER JOIN encounter e on p.patient_id=e.patient_id "
            + "where p.voided=0 and e.voided=0 and  e.encounter_type = 6 "
            + "and e.encounter_datetime  between  :startInclusionDate and :endInclusionDate and e.location_id=:location "
            + "group by patient_id "
            + ")maxEnc "
            + "inner join( "
            + "Select p.patient_id,encounter_datetime data_levantamento  from  patient p "
            + "inner join encounter e on e.patient_id=p.patient_id "
            + "where  p.voided=0 and e.voided=0 and e.encounter_type=18 and e.location_id=:location "
            + ")fila on fila.patient_id =  maxEnc.patient_id "
            + "where fila.data_levantamento<maxEnc.data "
            + "group by maxEnc.patient_id "
            + ") fila "
            + "inner join  obs obs_fila on obs_fila.person_id=fila.patient_id "
            + "and obs_fila.voided=0  and obs_fila.obs_datetime=fila.data_levantamento "
            + "and obs_fila.concept_id=5096 "
            + "and obs_fila.location_id=:location "
            + "and (DATEDIFF(obs_fila.value_datetime,fila.data_levantamento) >= 335 and DATEDIFF(obs_fila.value_datetime,fila.data_levantamento) <= 395) "
            + ") final group by patient_id ";

    public static final String findPatientsWhoHasRegisteredAsIniciarInAtLeastOneMDS =
        "select patient_id from( "
            + "select patient_id,data_mdc from ( "
            + "select maxEnc.patient_id,mdc.data_mdc  from  ( "
            + "select p.patient_id, max(e.encounter_datetime) data FROM patient p "
            + "INNER JOIN encounter e on p.patient_id=e.patient_id "
            + "where p.voided=0 and e.voided=0 and  e.encounter_type = 6 "
            + "and e.encounter_datetime  between :startInclusionDate and :endInclusionDate and e.location_id=:location "
            + "group by patient_id "
            + ")maxEnc "
            + " inner join ( "
            + "select p.patient_id,e.encounter_datetime data_mdc from patient p "
            + "join encounter e on p.patient_id=e.patient_id "
            + "join obs grupo on grupo.encounter_id=e.encounter_id "
            + "join obs o on o.encounter_id=e.encounter_id "
            + "join obs obsEstado on obsEstado.encounter_id=e.encounter_id "
            + "where  e.encounter_type in(6) and e.location_id=:location and o.concept_id=165174 and o.value_coded in(23724,23730,165179,165315,23888,23729,165314) and o.voided=0 "
            + "and grupo.concept_id=165323  and grupo.voided=0 and obsEstado.concept_id=165322  and obsEstado.value_coded in(1256)  and obsEstado.voided=0  and grupo.voided=0 "
            + "and grupo.obs_id=o.obs_group_id and grupo.obs_id=obsEstado.obs_group_id "
            + ")mdc on mdc.patient_id = maxEnc.patient_id "
            + "where mdc.data_mdc=maxEnc.data "
            + ") mdc "
            + "group by mdc.patient_id "
            + "union "
            + "select tipodispensa.patient_id,data_mdc from( "
            + "select maxEnc.patient_id,max(td.data_mdc) data_mdc from  ( "
            + "select p.patient_id, max(e.encounter_datetime) data FROM patient p "
            + "INNER JOIN encounter e on p.patient_id=e.patient_id "
            + "where p.voided=0 and e.voided=0 and  e.encounter_type = 6 "
            + "and e.encounter_datetime  between  :startInclusionDate and :endInclusionDate and e.location_id=:location "
            + "group by patient_id "
            + ")maxEnc "
            + "inner join( "
            + "select p.patient_id,o.obs_datetime data_mdc from patient p "
            + "join encounter e on p.patient_id=e.patient_id "
            + "join obs o on o.encounter_id=e.encounter_id "
            + "where e.encounter_type=6 and e.voided=0 and o.voided=0 and p.voided=0 and o.concept_id=23739 and e.location_id=:location "
            + ") td on td.patient_id = maxEnc.patient_id "
            + "where td.data_mdc=maxEnc.data "
            + "group by maxEnc.patient_id "
            + ") tipodispensa "
            + "inner join encounter e on e.patient_id = tipodispensa.patient_id "
            + "inner join obs o on o.encounter_id=e.encounter_id "
            + "where tipodispensa.data_mdc=e.encounter_datetime and o.concept_id=23739 "
            + "and e.voided=0 and o.value_coded in(23720,23888,165314) and o.voided=0 and o.location_id=:location "
            + "union "
            + "select f.patient_id,f.data_levantamento data_mdc from "
            + "( "
            + "select fila.patient_id,max(fila.data_levantamento) data_levantamento,obs_fila.value_datetime data_proximo_levantamento  from   ( "
            + "Select p.patient_id,max(encounter_datetime) data_levantamento  from  patient p "
            + "inner join encounter e on e.patient_id=p.patient_id "
            + "where  p.voided=0 and e.voided=0 and e.encounter_type=18 and e.location_id=:location "
            + "and e.encounter_datetime between  :startInclusionDate and :endInclusionDate "
            + "group by p.patient_id "
            + ")fila "
            + "inner join  obs obs_fila on obs_fila.person_id=fila.patient_id "
            + "and obs_fila.voided=0  and obs_fila.obs_datetime=fila.data_levantamento "
            + "and obs_fila.concept_id=5096 "
            + "and obs_fila.location_id=:location "
            + "and (DATEDIFF(obs_fila.value_datetime,fila.data_levantamento) >= 83 and DATEDIFF(obs_fila.value_datetime,fila.data_levantamento) <= 97) "
            + "group by fila.patient_id "
            + ") f "
            + "union "
            + "select f.patient_id,f.data_levantamento data_mdc from   ( "
            + "select fila.patient_id,max(fila.data_levantamento) data_levantamento,obs_fila.value_datetime data_proximo_levantamento  from  ( "
            + "Select p.patient_id,max(encounter_datetime) data_levantamento  from  patient p "
            + "inner join encounter e on e.patient_id=p.patient_id "
            + "where  p.voided=0 and e.voided=0 and e.encounter_type=18 and e.location_id=:location "
            + "and e.encounter_datetime between  :startInclusionDate and :endInclusionDate "
            + "group by p.patient_id "
            + ")fila "
            + "inner join  obs obs_fila on obs_fila.person_id=fila.patient_id "
            + "and obs_fila.voided=0  and obs_fila.obs_datetime=fila.data_levantamento "
            + "and obs_fila.concept_id=5096 "
            + "and obs_fila.location_id=:location "
            + "where (DATEDIFF(obs_fila.value_datetime,fila.data_levantamento) >= 173 and DATEDIFF(obs_fila.value_datetime,fila.data_levantamento) <= 187) "
            + "group by fila.patient_id "
            + ") f "
            + "union "
            + "select f.patient_id,f.data_levantamento data_mdc from   ( "
            + "select fila.patient_id,max(fila.data_levantamento) data_levantamento,obs_fila.value_datetime data_proximo_levantamento  from  ( "
            + "Select p.patient_id,max(encounter_datetime) data_levantamento  from  patient p "
            + "inner join encounter e on e.patient_id=p.patient_id "
            + "where  p.voided=0 and e.voided=0 and e.encounter_type=18 and e.location_id=:location "
            + "and e.encounter_datetime between  :startInclusionDate and :endInclusionDate "
            + "group by p.patient_id "
            + ")fila "
            + "inner join  obs obs_fila on obs_fila.person_id=fila.patient_id "
            + "and obs_fila.voided=0  and obs_fila.obs_datetime=fila.data_levantamento "
            + "and obs_fila.concept_id=5096 "
            + "and obs_fila.location_id=:location "
            + "where (DATEDIFF(obs_fila.value_datetime,fila.data_levantamento) >= 335 and DATEDIFF(obs_fila.value_datetime,fila.data_levantamento) <= 395) "
            + "group by fila.patient_id "
            + ") f "
            + ") final ";

    public static final String findPatientsWhoHasRegisteredAsFimInAtLeastOneMDS =
        "select maxEnc.patient_id  from (  "
            + "select p.patient_id,max(e.encounter_datetime) data_ultima_consulta FROM patient p  "
            + "INNER JOIN encounter e on p.patient_id=e.patient_id  "
            + "where p.voided=0 and e.voided=0 and  e.encounter_type = 6  "
            + "and e.encounter_datetime  between :startInclusionDate and  :endInclusionDate and e.location_id =:location  "
            + "group by patient_id  "
            + ")maxEnc  "
            + "inner join  "
            + "(  "
            + "select p.patient_id, e.encounter_datetime   data_mdc FROM patient p    "
            + "join encounter e on p.patient_id=e.patient_id    "
            + "join obs grupo on grupo.encounter_id=e.encounter_id    "
            + "join obs o on o.encounter_id=e.encounter_id     "
            + "join obs obsEstado on obsEstado.encounter_id=e.encounter_id   "
            + "where  e.encounter_type=6 and o.concept_id=165174 and o.value_coded in(23724,23730,23888,165179,23729,165315) and grupo.concept_id=165323    "
            + "and obsEstado.concept_id=165322  and obsEstado.value_coded in (1267) and  e.location_id=:location   "
            + "and p.voided=0 and e.voided=0 and o.voided=0 and grupo.voided=0 and obsEstado.voided=0 and e.encounter_datetime<:endRevisionDate  "
            + ") mdc on mdc.patient_id= maxEnc.patient_id "
            + "inner join "
            + "( "
            + "select p.patient_id,e.encounter_datetime data_cv,o.value_numeric valor from patient p   "
            + "inner join encounter e on e.patient_id=p.patient_id   "
            + "inner join obs o on o.encounter_id=e.encounter_id   "
            + "where e.encounter_type=6 and o.concept_id=856 and p.voided=0 and e.voided=0 and o.voided=0 and o.value_numeric>=1000  "
            + ") cvLab on maxEnc.patient_id=cvLab.patient_id  "
            + "inner join ( "
            + "select fila.patient_id,max(fila.data_levantamento) data_levantamento,obs_fila.value_datetime data_proximo_levantamento  from  (   "
            + "Select p.patient_id,max(encounter_datetime) data_levantamento  from  patient p  "
            + "inner join encounter e on e.patient_id=p.patient_id   "
            + "where  p.voided=0 and e.voided=0 and e.encounter_type=18 and e.location_id=:location and e.encounter_datetime<=:endRevisionDate   "
            + "group by p.patient_id  "
            + ")fila   "
            + "inner join  obs obs_fila on obs_fila.person_id=fila.patient_id  "
            + "and obs_fila.voided=0  and obs_fila.obs_datetime=fila.data_levantamento   "
            + "and obs_fila.concept_id=5096 "
            + "and obs_fila.location_id=:location  "
            + "group by fila.patient_id "
            + ") fila on fila.patient_id=cvLab.patient_id "
            + "where  (fila.data_levantamento>maxEnc.data_ultima_consulta)and (DATEDIFF(fila.data_proximo_levantamento,fila.data_levantamento) >= 23)  "
            + "and (DATEDIFF(fila.data_proximo_levantamento,fila.data_levantamento) <=37) ";

    public static final String
        findPatientsWhoHasRegisteredAsFimInAtLeastOneMDCOnTheLastClinicalConsultationInInclusionPeriod =
            "select patient_id from ( "
                + "select maxEnc.patient_id,mdc.data_mdc  from  ( "
                + "select p.patient_id, max(e.encounter_datetime) data FROM patient p "
                + "INNER JOIN encounter e on p.patient_id=e.patient_id "
                + "where p.voided=0 and e.voided=0 and  e.encounter_type = 6 "
                + "and e.encounter_datetime  between :startInclusionDate and :endInclusionDate and e.location_id=:location "
                + "group by patient_id "
                + ")maxEnc "
                + " inner join ( "
                + "select p.patient_id,e.encounter_datetime data_mdc from patient p "
                + "join encounter e on p.patient_id=e.patient_id "
                + "join obs grupo on grupo.encounter_id=e.encounter_id "
                + "join obs o on o.encounter_id=e.encounter_id "
                + "join obs obsEstado on obsEstado.encounter_id=e.encounter_id "
                + "where  e.encounter_type in(6) and e.location_id=:location and o.concept_id=165174 and o.value_coded in(23724,23730,165179,165315,23888,23729) and o.voided=0 "
                + "and grupo.concept_id=165323  and grupo.voided=0 and obsEstado.concept_id=165322  and obsEstado.value_coded in(1267)  and obsEstado.voided=0  and grupo.voided=0 "
                + "and grupo.obs_id=o.obs_group_id and grupo.obs_id=obsEstado.obs_group_id "
                + ")mdc on mdc.patient_id = maxEnc.patient_id "
                + "where mdc.data_mdc=maxEnc.data "
                + ") mdc "
                + "group by mdc.patient_id ";

    public static final String
        findPatientsWhoHasCVBiggerThan1000InLastClinicalConsultationAndHaveARTPickUp =
            "select result.patient_id from ( "
                + "select cv.patient_id, max(clinica.data_consulta) data_consulta from "
                + "( "
                + "select maxEnc.patient_id,maxEnc.data_ultima_consulta, cvLab.data_cv,cvLab.valor from  ( "
                + "select p.patient_id, max(e.encounter_datetime) data_ultima_consulta FROM patient p "
                + "INNER JOIN encounter e on p.patient_id=e.patient_id "
                + "where p.voided=0 and e.voided=0 and  e.encounter_type = 6 "
                + "and e.encounter_datetime  between :startInclusionDate and :endInclusionDate and e.location_id=:location "
                + "group by patient_id "
                + ")maxEnc "
                + "inner join ( "
                + "select p.patient_id,e.encounter_datetime data_cv,o.value_numeric valor from patient p "
                + "inner join encounter e on e.patient_id=p.patient_id "
                + "inner join obs o on o.encounter_id=e.encounter_id "
                + "where e.encounter_type=6 and o.concept_id=856 and p.voided=0 and e.voided=0 and o.voided=0 and o.value_numeric>=1000 "
                + ") cvLab on maxEnc.patient_id=cvLab.patient_id "
                + "where maxEnc.data_ultima_consulta=cvLab.data_cv "
                + ")cv "
                + "inner join ( "
                + "select clinica.patient_id,clinica.data_consulta,obs_proxima.value_datetime data_proxima_consulta  from  ( "
                + "Select p.patient_id,encounter_datetime data_consulta  from  patient p "
                + "inner join encounter e on e.patient_id=p.patient_id "
                + "where  p.voided=0 and e.voided=0 and e.encounter_type=6 and e.location_id=:location "
                + ")clinica "
                + "inner join  obs obs_proxima on obs_proxima.person_id=clinica.patient_id "
                + "and obs_proxima.voided=0  and obs_proxima.obs_datetime=clinica.data_consulta "
                + "and obs_proxima.concept_id=1410 "
                + "and obs_proxima.location_id=:location "
                + ")clinica "
                + "where  (clinica.data_consulta>=cv.data_ultima_consulta and clinica.data_consulta<=:endRevisionDate ) and (DATEDIFF(clinica.data_proxima_consulta,clinica.data_consulta) >= 23) "
                + "and (DATEDIFF(clinica.data_proxima_consulta,clinica.data_consulta) <=37) and cv.patient_id = clinica.patient_id "
                + "group by  cv.patient_id "
                + ")result ";

    public static final String
        findPatientsWhoHaveTbTreatmentMarkedEnd30DaysBeforeTheLastAppointment =
            "select f.patient_id from "
                + "( "
                + "select lastEnc.patient_id,lastEnc.enc, tb.data_fim_tb "
                + "from "
                + "( "
                + "Select p.patient_id,max(e.encounter_datetime) enc from patient p "
                + "inner join encounter e on p.patient_id=e.patient_id "
                + "where p.voided=0 and e.voided=0 and e.encounter_type=6 and "
                + "e.encounter_datetime BETWEEN date_sub(:endRevisionDate , interval 2 MONTH) AND  date_sub(:endRevisionDate , interval 1 MONTH)  and e.location_id=:location "
                + "group by p.patient_id "
                + ")lastEnc "
                + "inner join "
                + "( "
                + "select p.patient_id,max(o.obs_datetime) as data_fim_tb "
                + "from patient p "
                + "inner join encounter e on p.patient_id=e.patient_id "
                + "inner join obs o on o.encounter_id=e.encounter_id "
                + "where e.encounter_type=6 and e.voided=0 and o.voided=0 and p.voided=0 and o.concept_id=1268 "
                + "and o.value_coded=1267 "
                + "and e.location_id=:location "
                + "and e.encounter_datetime <= :endRevisionDate "
                + "group by p.patient_id "
                + ")tb on lastEnc.patient_id=tb.patient_id "
                + "WHERE ABS(DATEDIFF(lastEnc.enc,tb.data_fim_tb)) <= 30 "
                + " order by lastEnc.enc desc "
                + " )f ";
  }
}
